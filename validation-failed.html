<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>360 QC Review Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f7fa;
      color: #333;
      padding: 40px 20px;
      margin: 0;
    }
    h2 {
      font-weight: 700;
      color: #222;
      margin-bottom: 30px;
      text-align: center;
      letter-spacing: 1.2px;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      align-items: flex-end;
      gap: 20px 30px;
      margin-bottom: 30px;
    }
    .filters > div {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .filters label {
      font-weight: 600;
      color: #555;
    }
    .filters select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      min-width: 150px;
      cursor: pointer;
    }
    .table-container {
      overflow-x: auto;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spapse: 0;
    }
    thead th {
      text-align: left;
      padding: 15px;
      background-color: #eef2f7;
      border-bottom: 2px solid #ddd;
      font-size: 13px;
      font-weight: 700;
      color: #666;
      text-transform: uppercase;
    }
    tbody tr {
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s ease;
    }
    tbody tr:hover {
      background-color: #f8fbfd;
    }
    tbody td {
      padding: 15px;
      font-size: 14px;
      color: #444;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-passed {
      background-color: #4CAF50;
    }
    .status-failed {
      background-color: #f44336;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      font-size: 18px;
      color: #666;
    }
    .loading::after {
      content: "";
      width: 20px;
      height: 20px;
      margin-left: 10px;
      border: 3px solid #ddd;
      border-radius: 50%;
      border-top-color: #4CAF50;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .data-info {
      text-align: center;
      padding: 15px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h2>360 QC Review Dashboard</h2>
  <div class="filters">
    <div>
      <label for="month-filter">Month:</label>
      <select id="month-filter">
        <option value="">All Months</option>
      </select>
    </div>
    <div>
      <label for="enterprise-filter">Enterprise:</label>
      <select id="enterprise-filter">
        <option value="">All Enterprises</option>
      </select>
    </div>
    <div>
      <label for="user-filter">User:</label>
      <select id="user-filter">
        <option value="">All Users</option>
      </select>
    </div>
    <div>
      <label for="product-type-filter">Product Type:</label>
      <select id="product-type-filter">
        <option value="">All Types</option>
      </select>
    </div>
    <div>
      <label for="status-filter">Status:</label>
      <select id="status-filter">
        <option value="">All Status</option>
        <option value="Passed">Passed</option>
        <option value="Failed">Failed</option>
      </select>
    </div>
  </div>

  <div class="table-container">
    <div id="loading" class="loading">Loading data...</div>
    <table style="display: none;">
      <thead>
        <tr>
          <th>Spin ID</th>
          <th>SKU ID</th>
          <th>Enterprise</th>
          <th>User</th>
          <th>Product Type</th>
          <th>Status</th>
          <th>Issues</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
    <div id="data-info" class="data-info" style="display: none;"></div>
  </div>

  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTmm6um2dDueAholFhs2olel5wv2mqH9f1jCAfdL8Qi76mzqbTfzu7OYRea5PwSJP0eD0RLuF6XOkTy/pub?gid=0&single=true&output=csv';
    
    const elements = {
      tableBody: document.getElementById('table-body'),
      loading: document.getElementById('loading'),
      table: document.querySelector('table'),
      dataInfo: document.getElementById('data-info'),
      monthFilter: document.getElementById('month-filter'),
      enterpriseFilter: document.getElementById('enterprise-filter'),
      userFilter: document.getElementById('user-filter'),
      productTypeFilter: document.getElementById('product-type-filter'),
      statusFilter: document.getElementById('status-filter')
    };

    let allData = [];
    let filteredData = [];

    const fetchCsvData = async () => {
      try {
        const response = await fetch(CSV_URL);
        if (!response.ok) throw new Error('Failed to fetch CSV data');
        const text = await response.text();
        const { data } = Papa.parse(text, { header: true, skipEmptyLines: true });
        
        // Process data
        allData = data.map(row => {
          // Determine status based on validation columns
          const status = (row['validation_status'] === 'Passed' && row['vdp_validation_status'] === 'Passed') ? 'Passed' : 'Failed';
          
          // Combine issues
          const issues = [];
          if (row['validation_failure_reason']) issues.push(row['validation_failure_reason']);
          if (row['vdp_validation_failure_reason']) issues.push(row['vdp_validation_failure_reason']);
          
          return {
            spinId: row['Spin_id'] || 'N/A',
            skuId: row['Sku_id'] || 'N/A',
            enterprise: row['Enterprise'] || 'N/A',
            user: row['QC'] || 'N/A',
            productType: row['Product_Type'] || 'N/A',
            status: status,
            issues: issues.join('; ') || 'None',
            month: row['Month'] || 'N/A'
          };
        });
        
        populateFilters();
        applyFilters();
        
        // Hide loading, show table
        elements.loading.style.display = 'none';
        elements.table.style.display = 'table';
        
      } catch (error) {
        elements.loading.textContent = 'Error loading data. Please try again later.';
        console.error('Error fetching or parsing CSV:', error);
      }
    };

    const populateFilters = () => {
      const getUniqueValues = (key) => {
        const values = [...new Set(allData.map(d => d[key]))].filter(Boolean);
        return values.sort();
      };
      
      const fillSelect = (select, values) => {
        values.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          select.appendChild(option);
        });
      };
      
      fillSelect(elements.monthFilter, getUniqueValues('month'));
      fillSelect(elements.enterpriseFilter, getUniqueValues('enterprise'));
      fillSelect(elements.userFilter, getUniqueValues('user'));
      fillSelect(elements.productTypeFilter, getUniqueValues('productType'));
    };

    const applyFilters = () => {
      const selectedMonth = elements.monthFilter.value;
      const selectedEnterprise = elements.enterpriseFilter.value;
      const selectedUser = elements.userFilter.value;
      const selectedProductType = elements.productTypeFilter.value;
      const selectedStatus = elements.statusFilter.value;
      
      filteredData = allData.filter(row => {
        const monthMatch = !selectedMonth || row.month === selectedMonth;
        const enterpriseMatch = !selectedEnterprise || row.enterprise === selectedEnterprise;
        const userMatch = !selectedUser || row.user === selectedUser;
        const productTypeMatch = !selectedProductType || row.productType === selectedProductType;
        const statusMatch = !selectedStatus || row.status === selectedStatus;
        
        return monthMatch && enterpriseMatch && userMatch && productTypeMatch && statusMatch;
      });
      
      renderTable(filteredData);
      
      // Update data info
      elements.dataInfo.style.display = 'block';
      elements.dataInfo.textContent = `Showing ${filteredData.length} of ${allData.length} records`;
    };

    const renderTable = (data) => {
      elements.tableBody.innerHTML = '';
      
      if (data.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="7" style="text-align: center; color: #888;">No records found matching your filters.</td>`;
        elements.tableBody.appendChild(row);
        return;
      }
      
      data.forEach(row => {
        const tr = document.createElement('tr');
        const statusClass = row.status === 'Passed' ? 'status-passed' : 'status-failed';
        
        tr.innerHTML = `
          <td>${escapeHtml(row.spinId)}</td>
          <td>${escapeHtml(row.skuId)}</td>
          <td>${escapeHtml(row.enterprise)}</td>
          <td>${escapeHtml(row.user)}</td>
          <td>${escapeHtml(row.productType)}</td>
          <td><span class="status-indicator ${statusClass}"></span>${escapeHtml(row.status)}</td>
          <td>${escapeHtml(row.issues)}</td>
        `;
        elements.tableBody.appendChild(tr);
      });
    };

    const escapeHtml = (text) => {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };

    // Set up event listeners for filters
    elements.monthFilter.addEventListener('change', applyFilters);
    elements.enterpriseFilter.addEventListener('change', applyFilters);
    elements.userFilter.addEventListener('change', applyFilters);
    elements.productTypeFilter.addEventListener('change', applyFilters);
    elements.statusFilter.addEventListener('change', applyFilters);

    // Load data
    fetchCsvData();
  </script>
</body>
</html>
